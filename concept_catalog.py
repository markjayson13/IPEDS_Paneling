"""Concept catalog for label-driven IPEDS harmonization.

This module exposes the ``CONCEPTS`` dictionary used by ``harmonize_new`` to
identify and extract concept-aligned variables from IPEDS survey files. The
catalog replaces CSV crosswalks with an in-repo Python source of truth. Each
concept entry specifies its descriptive metadata, acceptable forms, matching
patterns, and transform hints.

The harmonizer consumes this catalog to drive label-based resolution against the
``dictionary_lake.parquet`` generated by ``01_ingest_dictionaries.py``. When
``download_ipeds.py`` refreshes yearly manifests, ``harmonize_new`` can combine
those manifests with the concept catalog to locate and parse the correct survey
files without editing legacy modules.
"""

from __future__ import annotations

from collections import OrderedDict
import re


GLOBAL_EXCLUDE = re.compile(r"^(unitid|instnm|opeid.*|^id$)", re.I)


CONCEPTS: "OrderedDict[str, dict[str, object]]" = OrderedDict(
    {
        # =====================================================
        # Institutional Characteristics (IC/HD) — Directory info
        # =====================================================
        "dir_inst_name": {
            "target_var": "dir_inst_name",
            "concept": "Institution name",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^institution.*name$|^name of institution$"],
            "exclude_regex": [r"contact|mission|website|alias|short name|athletic|library"],
        },
        "dir_city": {
            "target_var": "dir_city",
            "concept": "City",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^city(?: location of institution)?$"],
            "exclude_regex": [r"mailing|county|country"],
        },
        "dir_state_abbr": {
            "target_var": "dir_state_abbr",
            "concept": "State abbreviation",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^state abbreviation$|^state$"],
            "exclude_regex": [r"fips|county"],
        },
        "dir_zip": {
            "target_var": "dir_zip",
            "concept": "ZIP code",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^zip code$|^zip$"],
            "exclude_regex": [r"plus|mailing"],
        },
        "dir_ein": {
            "target_var": "dir_ein",
            "concept": "Employer Identification Number",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^employer identification number$|^ein$"],
            "exclude_regex": [],
        },
        "dir_opeflag": {
            "target_var": "dir_opeflag",
            "concept": "OPE Title IV eligibility indicator code",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^ope title iv eligibility indicator code$|^title iv participant$"],
            "exclude_regex": [],
        },
        "dir_opeid": {
            "target_var": "dir_opeid",
            "concept": "Office of Postsecondary Education (OPE) ID number",
            "units": "id",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^ope id number$|^office of postsecondary education.*id number$"],
            "exclude_regex": [],
        },
        "dir_multi_campus_org": {
            "target_var": "dir_multi_campus_org",
            "concept": "Multi-institution or multi-campus organization indicator",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^multi[- ]institution or multi[- ]campus organization$"],
            "exclude_regex": [],
        },
        "dir_multi_campus_id": {
            "target_var": "dir_multi_campus_id",
            "concept": "ID of multi-institution or multi-campus organization",
            "units": "id",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2013,
            "label_regex": [r"^identification number of multi[- ]institution or multi[- ]campus organization$"],
            "exclude_regex": [],
        },
        "dir_county_fips": {
            "target_var": "dir_county_fips",
            "concept": "County FIPS code",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2009,
            "label_regex": [r"^fips county code$|^county fips code$"],
            "exclude_regex": [],
        },
        "dir_county_name": {
            "target_var": "dir_county_name",
            "concept": "County name",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2009,
            "label_regex": [r"^county name$"],
            "exclude_regex": [],
        },
        "dir_congress_district": {
            "target_var": "dir_congress_district",
            "concept": "Congressional district code",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2009,
            "label_regex": [r"^congressional district code$"],
            "exclude_regex": [],
        },
        "dir_cbsa_code": {
            "target_var": "dir_cbsa_code",
            "concept": "Core Based Statistical Area (CBSA)",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^core based statistical area.*$|^cbsa$"],
            "exclude_regex": [],
        },
        "dir_cbsa_type": {
            "target_var": "dir_cbsa_type",
            "concept": "CBSA type (metropolitan or micropolitan)",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^cbsa type.*metropolitan or micropolitan$|^cbsa type$"],
            "exclude_regex": [],
        },
        "dir_csa_code": {
            "target_var": "dir_csa_code",
            "concept": "Combined Statistical Area (CSA)",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^combined statistical area.*$|^csa$"],
            "exclude_regex": [],
        },
        "dir_necta_code": {
            "target_var": "dir_necta_code",
            "concept": "New England City and Town Areas (NECTA)",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^new england city and town areas.*$|^necta.*$"],
            "exclude_regex": [],
        },
        "dir_longitude": {
            "target_var": "dir_longitude",
            "concept": "Longitude",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2009,
            "label_regex": [r"^longitude.*location of institution$|^longitude$"],
            "exclude_regex": [],
        },
        "dir_latitude": {
            "target_var": "dir_latitude",
            "concept": "Latitude",
            "units": "text",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2009,
            "label_regex": [r"^latitude.*location of institution$|^latitude$"],
            "exclude_regex": [],
        },
        "ic_open_public": {
            "target_var": "ic_open_public",
            "concept": "Institution open to the general public",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^institution open to the general public$"],
            "exclude_regex": [],
        },
        "ic_active_in_year": {
            "target_var": "ic_active_in_year",
            "concept": "Institution is active in current year",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^institution is active in current year$|^status of institution$"],
            "exclude_regex": [],
        },

        # =====================================================
        # Institutional classifications
        # =====================================================
        "ic_sector": {
            "target_var": "ic_sector",
            "concept": "Sector of institution",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^sector of institution$|^sector$"],
            "exclude_regex": [],
        },
        "ic_control": {
            "target_var": "ic_control",
            "concept": "Control of institution",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^control of institution$|^control$"],
            "exclude_regex": [],
        },
        "ic_level": {
            "target_var": "ic_level",
            "concept": "Level of institution",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^level of institution$|^institution level$"],
            "exclude_regex": [],
        },
        "ic_degree_granting": {
            "target_var": "ic_degree_granting",
            "concept": "Degree-granting status",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^degree[- ]granting status$"],
            "exclude_regex": [],
        },
        "ic_highest_degree_offered": {
            "target_var": "ic_highest_degree_offered",
            "concept": "Highest degree offered",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^highest degree offered.*$"],
            "exclude_regex": [],
            "notes": "Label revised in 2009-10; regex tolerates both versions.",
        },
        "ic_institutional_category": {
            "target_var": "ic_institutional_category",
            "concept": "Institutional category",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^institutional category$"],
            "exclude_regex": [],
        },
        "ic_highest_level_offering": {
            "target_var": "ic_highest_level_offering",
            "concept": "Highest level of offering",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^highest level of offering$"],
            "exclude_regex": [],
        },
        "ic_ug_offering": {
            "target_var": "ic_ug_offering",
            "concept": "Undergraduate offering",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^undergraduate offering$"],
            "exclude_regex": [],
        },
        "ic_gr_offering": {
            "target_var": "ic_gr_offering",
            "concept": "Graduate offering",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^graduate offering$"],
            "exclude_regex": [],
        },
        "ic_urbanicity": {
            "target_var": "ic_urbanicity",
            "concept": "Degree of urbanization (urban-centric locale)",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^degree of urbanization.*$|^urban[- ]?centric locale$|^urbanization$|^urbanicity$"],
            "exclude_regex": [],
        },

        # =====================================================
        # Control or affiliation
        # =====================================================
        "ic_affiliation": {
            "target_var": "ic_affiliation",
            "concept": "Institutional control or affiliation",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^institutional control or affiliation$"],
            "exclude_regex": [],
        },
        "ic_public_control_primary": {
            "target_var": "ic_public_control_primary",
            "concept": "Primary public control",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^primary public control$"],
            "exclude_regex": [],
        },
        "ic_public_control_secondary": {
            "target_var": "ic_public_control_secondary",
            "concept": "Secondary public control",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^secondary public control$"],
            "exclude_regex": [],
        },
        "ic_religious_affiliation": {
            "target_var": "ic_religious_affiliation",
            "concept": "Religious affiliation",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^religious affiliation$"],
            "exclude_regex": [],
        },

        # =====================================================
        # Response status / flags (IC)
        # =====================================================
        "ic_response_status": {
            "target_var": "ic_response_status",
            "concept": "Response status — IC component",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^response status.*institutional characteristics$|^response status - institutional characteristics$"],
            "exclude_regex": [],
        },
        "ic_revision_status": {
            "target_var": "ic_revision_status",
            "concept": "Revision status — IC component",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2008,
            "max_year": 2023,
            "label_regex": [r"^revision status.*institutional characteristics component$"],
            "exclude_regex": [],
            "notes": "Applicable 2008-09 to 2022-23 per IC documentation.",
        },
        "ic_status_when_migrated": {
            "target_var": "ic_status_when_migrated",
            "concept": "Status of IC component when institution was migrated",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^status of ic component when institution was migrated$"],
            "exclude_regex": [],
        },
        "ic_imputation_method": {
            "target_var": "ic_imputation_method",
            "concept": "Type of imputation method — IC",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^type of imputation method.*institutional characteristics$|^imputation method.*institutional characteristics$"],
            "exclude_regex": [],
        },

        # =====================================================
        # Institutional Characteristics (IC) — admissions & policy
        # =====================================================
        "ic_calendar_system": {
            "target_var": "ic_calendar_system",
            "concept": "Calendar system",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^calendar system$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_open_admissions": {
            "target_var": "ic_open_admissions",
            "concept": "Open admissions policy",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^open admissions?$|^open admissions? policy$|^open admission policy$"],
            "exclude_regex": [r"test|sat|act|requirement|recommend"],
            "transform": "identity",
        },
        "ic_distance_programs": {
            "target_var": "ic_distance_programs",
            "concept": "Offers distance education programs",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "label_regex": [r"^offers distance education programs?$|^distance education programs?$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_parent_unitid": {
            "target_var": "ic_parent_unitid",
            "concept": "Parent UNITID",
            "units": "id",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^parent.*unitid$|^unitid of parent$|^parent id$"],
            "exclude_regex": [],
            "notes": "Feeds parent/child handling in harmonizer.",
            "transform": "identity",
        },
        "ic_hbcu_flag": {
            "target_var": "ic_hbcu_flag",
            "concept": "Historically Black College or University indicator",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^historically black college or university$|^hbcu$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_tribal_flag": {
            "target_var": "ic_tribal_flag",
            "concept": "Tribal college indicator",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^tribal college$|^american indian.*tribal$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_med_school_flag": {
            "target_var": "ic_med_school_flag",
            "concept": "Medical school indicator",
            "units": "code",
            "survey": "InstitutionalCharacteristics",
            "period_type": "static",
            "label_regex": [r"^medical school (?:indicator|flag)$|^has medical school$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_tuition_ug_in_district": {
            "target_var": "ic_tuition_ug_in_district",
            "concept": "Undergraduate tuition & fees (in-district)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^undergraduate.*in[- ]district.*tuition.*required fees.*$",
                r"^tuition.*required fees.*undergraduate.*in[- ]district.*$",
            ],
            "exclude_regex": [r"per (credit|unit|hour)", r"\bgraduate\b", r"\bcomprehensive fee\b"],
            "transform": "identity",
        },
        "ic_tuition_ug_in_state": {
            "target_var": "ic_tuition_ug_in_state",
            "concept": "Undergraduate tuition & fees (in-state)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^undergraduate.*in[- ]state.*tuition.*required fees.*$",
                r"^tuition.*required fees.*undergraduate.*in[- ]state.*$",
            ],
            "exclude_regex": [r"per (credit|unit|hour)", r"\bgraduate\b", r"\bcomprehensive fee\b"],
            "transform": "identity",
        },
        "ic_tuition_ug_out_state": {
            "target_var": "ic_tuition_ug_out_state",
            "concept": "Undergraduate tuition & fees (out-of-state)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^undergraduate.*out[- ]of[- ]state.*tuition.*required fees.*$",
                r"^tuition.*required fees.*undergraduate.*out[- ]of[- ]state.*$",
            ],
            "exclude_regex": [r"per (credit|unit|hour)", r"\bgraduate\b", r"\bcomprehensive fee\b"],
            "transform": "identity",
        },
        "ic_tuition_gr_in_state": {
            "target_var": "ic_tuition_gr_in_state",
            "concept": "Graduate tuition & fees (in-state)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^graduate.*in[- ]state.*tuition.*required fees.*$",
                r"^tuition.*required fees.*graduate.*in[- ]state.*$",
            ],
            "exclude_regex": [r"per (credit|unit|hour)", r"\bundergraduate\b", r"\bcomprehensive fee\b"],
            "transform": "identity",
        },
        "ic_tuition_gr_out_state": {
            "target_var": "ic_tuition_gr_out_state",
            "concept": "Graduate tuition & fees (out-of-state)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^graduate.*out[- ]of[- ]state.*tuition.*required fees.*$",
                r"^tuition.*required fees.*graduate.*out[- ]of[- ]state.*$",
            ],
            "exclude_regex": [r"per (credit|unit|hour)", r"\bundergraduate\b", r"\bcomprehensive fee\b"],
            "transform": "identity",
        },
        "ic_comprehensive_fee_ug": {
            "target_var": "ic_comprehensive_fee_ug",
            "concept": "Undergraduate comprehensive fee",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^undergraduate.*comprehensive fee$|^comprehensive fee.*undergraduate$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_comprehensive_fee_gr": {
            "target_var": "ic_comprehensive_fee_gr",
            "concept": "Graduate comprehensive fee",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^graduate.*comprehensive fee$|^comprehensive fee.*graduate$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_coa_on_campus": {
            "target_var": "ic_coa_on_campus",
            "concept": "Cost of attendance total (on campus)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^cost of attendance.*on[- ]campus$|^coa.*on[- ]campus$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_coa_off_campus_not_family": {
            "target_var": "ic_coa_off_campus_not_family",
            "concept": "Cost of attendance total (off campus, not with family)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^cost of attendance.*off[- ]campus.*not with family$",
                r"^coa.*off[- ]campus.*not with family$",
            ],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_coa_off_campus_with_family": {
            "target_var": "ic_coa_off_campus_with_family",
            "concept": "Cost of attendance total (off campus, with family)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^cost of attendance.*off[- ]campus.*with family$",
                r"^coa.*off[- ]campus.*with family$",
            ],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_room_board_on_campus": {
            "target_var": "ic_room_board_on_campus",
            "concept": "Room and board (on campus)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^room and board.*on[- ]campus$",
                r"^housing and meals.*on[- ]campus$",
            ],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_room_board_off_campus_not_family": {
            "target_var": "ic_room_board_off_campus_not_family",
            "concept": "Room and board (off campus, not with family)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [
                r"^room and board.*off[- ]campus.*not with family$",
                r"^housing and meals.*off[- ]campus.*not with family$",
            ],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_other_exp_on_campus": {
            "target_var": "ic_other_exp_on_campus",
            "concept": "Other expenses (on campus)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^other expenses.*on[- ]campus$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_other_exp_off_campus_not_family": {
            "target_var": "ic_other_exp_off_campus_not_family",
            "concept": "Other expenses (off campus, not with family)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^other expenses.*off[- ]campus.*not with family$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_other_exp_off_campus_with_family": {
            "target_var": "ic_other_exp_off_campus_with_family",
            "concept": "Other expenses (off campus, with family)",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^other expenses.*off[- ]campus.*with family$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        "ic_books_supplies": {
            "target_var": "ic_books_supplies",
            "concept": "Books and supplies",
            "units": "USD",
            "survey": "InstitutionalCharacteristics",
            "period_type": "AY",
            "min_year": 2004,
            "max_year": 2023,
            "label_regex": [r"^books? and supplies?$|^books?$|^supplies?$"],
            "exclude_regex": [],
            "transform": "identity",
        },
        # -------------------------
        # Finance (FY, aligned forms)
        # -------------------------
        "total_rev_invest_return": {
            "target_var": "total_rev_invest_return",
            "concept": "Total revenues and investment return (aligned forms)",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A", "F3A"],
            "label_regex": [
                r"^total revenues? (?:and )?investment return$",
                r"^total revenues? (?:and )?other additions$",
                r"^total other revenues? (?:&|and) additions$",
                # Accept both modern and 2004-era labels; punctuation is preserved in source_label_norm
                r"^total revenues?(?: &| and )other additions(?:.*)?$",
                r"^total revenues?(?: and )?investment return(?:.*)?$",
                r"^total revenues?(?: and (?:other additions )?)?investment (?:return|income).*$",
                r"^total revenues?(?:,? operating and nonoperating)?.*investment (?:return|income).*$",
            ],
            "exclude_regex": [
                r"endowment (?:market )?value|net assets|liabilities",
                r"balance sheet|position",
            ],
            "notes": "Aligned total. Avoid stock accounts and balance-sheet lines.",
            "transform": "identity",
        },
        "tuition_fees_net": {
            "target_var": "tuition_fees_net",
            "concept": "Tuition and fees revenue, net of discounts/allowances",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A", "F3A"],
            "min_year": 2008,
            "label_regex": [
                r"^tuition(?: and)? fees.*after deducting (?:discounts|scholarship allowances)",
                r"^tuition(?: and)? fees.*\(net\)$",
                r"^net tuition(?: and)? fees$",
                r"^tuition(?: and)? fees[, ]+after deducting .*discounts?.*allowances.*$",
                r"^tuition(?: and)? fees.*net of .*allowances.*$",
            ],
            "exclude_regex": [
                r"\bgross\b",
                r"before deducting",
                r"^discounts? and allowances",
                r"^scholarship allowances",
                r"\b(before|gross)\b|discounts? (?:not )?deducted|allowances? (?:not )?deducted",
            ],
            "notes": "Map only the net line. Exclude allowances and gross.",
            "transform": "identity",
        },
        "state_appropriations": {
            "target_var": "state_appropriations",
            "concept": "State appropriations",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A"],
            "label_regex": [
                r"^state appropriations(?:,? (?:operating|nonoperating))?$",
                r"^state appropriations$",
            ],
            "exclude_regex": [],
            "notes": "Typically not present for for-profits.",
            "transform": "identity",
        },
        "investment_return": {
            "target_var": "investment_return",
            "concept": "Investment return (income, gains, losses)",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A", "F3A"],
            "label_regex": [
                r"^investment return(?:.*)$",
                r"^investment income(?:.*)$",
                r"^net investment (?:income|return)(?:.*)$",
            ],
            "exclude_regex": [
                r"endowment (?:market )?value",
            ],
            "notes": "Flow item; not the endowment stock.",
            "transform": "identity",
        },
        "auxiliary_rev": {
            "target_var": "auxiliary_rev",
            "concept": "Auxiliary enterprises revenue",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A", "F3A"],
            "label_regex": [
                r"^auxiliary (?:enterprise|enterprises) revenues?$",
                r"^sales and services of auxiliary enterprises$",
            ],
            "exclude_regex": [
                r"expenses?",
            ],
            "notes": "Revenue only; not auxiliary expenses.",
            "transform": "identity",
        },
        "total_expenses": {
            "target_var": "total_expenses",
            "concept": "Total expenses (aligned forms)",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A", "F3A"],
            "label_regex": [
                r"^total expenses?(?: and deductions)?$",
                r"^total expenses?$",
                r"^total.*expenses?.*$",
            ],
            "exclude_regex": [],
            "notes": "",
            "transform": "identity",
        },
        "instruction_exp": {
            "target_var": "instruction_exp",
            "concept": "Instruction expenses",
            "units": "USD",
            "survey": "Finance",
            "period_type": "FY",
            "forms": ["F1A", "F2A", "F3A"],
            "label_regex": [
                r"^instruction(?:\s*expenses?)?$",
                r"^instruction\s*-\s*total$",
                r"^instruction\b.*expenses?.*$",
                r"^instruction\b.*total.*$",
            ],
            "exclude_regex": [
                r"instructional support",
            ],
            "notes": "Functional expense.",
            "transform": "identity",
        },

        # -------------------------
        # Enrollment (AY)
        # -------------------------
        "ef_total": {
            "target_var": "ef_total",
            "concept": "Total fall headcount",
            "units": "count",
            "survey": "FallEnrollment",
            "period_type": "AY",
            "forms": ["EF"],
            "label_regex": [
                r"^grand total$",
                r"^all students total$",
                r"^total enrollment$",
                r"^total$",
            ],
            "exclude_regex": [
                r"undergraduate|graduate",
                r"\bmen\b|\bwomen\b|\bmale\b|\bfemale\b",
                r"nonresident|unknown",
                r"part[- ]?time|full[- ]?time",
                r"by race|ethnicity|age|level|resident|attendance",
            ],
            "notes": "Fall snapshot grand total only.",
            "transform": "identity",
        },
        "e12_fte": {
            "target_var": "e12_fte",
            "concept": "12-month FTE (NCES rule)",
            "units": "FTE",
            "survey": "12MonthEnrollment",
            "period_type": "AY",
            "forms": ["E12", "E1D", "EFFY", "EFIA"],
            "min_year": 2007,
            "label_regex": [
                r".*full[- ]?time equivalent.*$",
                r".*fte.*enrollment.*$",
                r".*12[- ]?month.*full[- ]?time equivalent.*$",
            ],
            "exclude_regex": [
                r"\bfall\b",
                r"\bef\b",
                r"\bundergraduate\b|\bgraduate\b",
                r"^unitid$|identifier|opeid",
            ],
            "notes": "Use E12/E1D/EFFY derived FTE; avoid EF fall FTE variants.",
            "transform": "identity",
        },

        # -------------------------
        # SFA (AY)
        # -------------------------
        "pell_recip_count": {
            "target_var": "pell_recip_count",
            "concept": "Pell Grant recipients (FTFT undergraduates)",
            "units": "count",
            "survey": "StudentFinancialAid",
            "period_type": "AY",
            "forms": ["SFA"],
            "min_year": 2009,
            "label_regex": [
                r"pell.*(?:recipients?|students (?:awarded|receiving)|number receiving).*full[- ]?time.*first[- ]?time",
                r".*full[- ]?time.*first[- ]?time.*pell.*",
            ],
            "exclude_regex": [
                r"amount|dollars|\$|total (?:aid|amount)|grant amount",
                r"\bavg\b|\baverage\b|\bper[- ]?recipient\b",
            ],
            "notes": "Restrict to FTFT cohort; exclude dollar amounts.",
            "transform": "identity",
        },
        "pell_amount": {
            "target_var": "pell_amount",
            "concept": "Pell Grant dollars",
            "units": "USD",
            "survey": "StudentFinancialAid",
            "period_type": "AY",
            "forms": ["SFA"],
            "min_year": 2009,
            "label_regex": [
                r"pell grants?.*(?:amount|dollars|\$|total)",
                r".*total amount.*pell grants?.*",
            ],
            "exclude_regex": [
                r"recipient|students|count|number",
                r"\bavg\b|\baverage\b|\bper[- ]?recipient\b",
            ],
            "notes": "Total Pell dollars; exclude counts and averages.",
            "transform": "identity",
        },

        # Net price (AY, Title IV cohort; SFA historically, CST in recent years)
        "anp_0_30": {
            "target_var": "anp_0_30",
            "concept": "Average net price 0–30k (Title IV)",
            "units": "USD",
            "survey": "SFA",
            "period_type": "AY",
            "forms": ["SFA", "CST"],
            "min_year": 2009,
            "label_regex": [
                r"average net price.*(?:less than\s*30[, ]?0{3}|0\s*[-–]\s*30[, ]?0{3}|0\s*to\s*30[, ]?0{3}|0\s*-\s*30k)",
                r"average net price.*title iv.*0.*30[, ]?000",
            ],
            "exclude_regex": [
                r"average amount of grant.*scholarship aid",
                r"\bgrant(?:s)? and scholarship(?:s)? aid\b",
                r"\bavg(?:erage)? amount\b",
            ],
            "requires_keywords": ["net price"],
            "notes": "Title IV band.",
            "transform": "identity",
            "band_min": 0,
            "band_max": 30000,
            "open_upper": False,
        },
        "anp_30_48": {
            "target_var": "anp_30_48",
            "concept": "Average net price 30–48k (Title IV)",
            "units": "USD",
            "survey": "SFA",
            "period_type": "AY",
            "forms": ["SFA", "CST"],
            "min_year": 2009,
            "label_regex": [
                r"average net price.*(?:30[, ]?0{3}?\s*(to|[-–])\s*48[, ]?0{3}|30[, ]?001\s*(to|[-–])\s*48[, ]?0{3})",
                r"average net price.*title iv.*30[, ]?001.*48[, ]?000",
            ],
            "exclude_regex": [
                r"average amount of grant.*scholarship aid",
                r"\bgrant(?:s)? and scholarship(?:s)? aid\b",
                r"\bavg(?:erage)? amount\b",
            ],
            "requires_keywords": ["net price"],
            "notes": "",
            "transform": "identity",
            "band_min": 30001,
            "band_max": 48000,
            "open_upper": False,
        },
        "anp_48_75": {
            "target_var": "anp_48_75",
            "concept": "Average net price 48–75k (Title IV)",
            "units": "USD",
            "survey": "SFA",
            "period_type": "AY",
            "forms": ["SFA", "CST"],
            "min_year": 2009,
            "label_regex": [
                r"average net price.*(?:48[, ]?0{3}?\s*(to|[-–])\s*75[, ]?0{3}|48[, ]?001\s*(to|[-–])\s*75[, ]?0{3})",
                r"average net price.*title iv.*48[, ]?001.*75[, ]?000",
            ],
            "exclude_regex": [
                r"average amount of grant.*scholarship aid",
                r"\bgrant(?:s)? and scholarship(?:s)? aid\b",
                r"\bavg(?:erage)? amount\b",
            ],
            "requires_keywords": ["net price"],
            "notes": "",
            "transform": "identity",
            "band_min": 48001,
            "band_max": 75000,
            "open_upper": False,
        },
        "anp_75_110": {
            "target_var": "anp_75_110",
            "concept": "Average net price 75–110k (Title IV)",
            "units": "USD",
            "survey": "SFA",
            "period_type": "AY",
            "forms": ["SFA", "CST"],
            "min_year": 2009,
            "label_regex": [
                r"average net price.*(?:75[, ]?0{3}?\s*(to|[-–])\s*110[, ]?0{3}|75[, ]?001\s*(to|[-–])\s*110[, ]?0{3})",
                r"average net price.*title iv.*75[, ]?001.*110[, ]?000",
            ],
            "exclude_regex": [
                r"average amount of grant.*scholarship aid",
                r"\bgrant(?:s)? and scholarship(?:s)? aid\b",
                r"\bavg(?:erage)? amount\b",
            ],
            "requires_keywords": ["net price"],
            "notes": "",
            "transform": "identity",
            "band_min": 75001,
            "band_max": 110000,
            "open_upper": False,
        },
        "anp_110_plus": {
            "target_var": "anp_110_plus",
            "concept": "Average net price 110k+ (Title IV)",
            "units": "USD",
            "survey": "SFA",
            "period_type": "AY",
            "forms": ["SFA", "CST"],
            "min_year": 2009,
            "label_regex": [
                r"average net price.*(110[, ]?0{3}\s*(or more|\+)|110[, ]?001\s*(or more|\+))",
                r"average net price.*(110[, ]?001|110[, ]?000 or more)",
            ],
            "exclude_regex": [
                r"average amount of grant.*scholarship aid",
                r"\bgrant(?:s)? and scholarship(?:s)? aid\b",
                r"\bavg(?:erage)? amount\b",
            ],
            "requires_keywords": ["net price"],
            "notes": "",
            "transform": "identity",
            "band_min": 110000,
            "band_max": None,
            "open_upper": True,
        },
    }
)
